name: Weekly NFL Process (Elimination & Projections)

on:
  schedule:
    # Martes a las 6:00 AM EST (11:00 UTC)
    - cron: '0 11 * * 2'
  workflow_dispatch: # Permitir ejecuci√≥n manual
    inputs:
      season:
        description: 'NFL Season Year (deja vac√≠o para a√±o actual)'
        required: false
        type: string

jobs:
  weekly-process:
    runs-on: ubuntu-latest
    name: Proceso Semanal NFL

    steps:
      - name: Determinar temporada NFL
        id: season
        run: |
          if [ -n "${{ github.event.inputs.season }}" ]; then
            echo "SEASON=${{ github.event.inputs.season }}" >> $GITHUB_OUTPUT
          else
            echo "SEASON=$(date +%Y)" >> $GITHUB_OUTPUT
          fi
          echo "üìÖ Temporada NFL: $(cat $GITHUB_OUTPUT | grep SEASON | cut -d= -f2)"

      - name: Step 1 - Ejecutar proceso de eliminaci√≥n semanal
        id: elimination
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET || secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SEASON: ${{ steps.season.outputs.SEASON }}
        run: |
          echo "üèà Iniciando proceso de eliminaci√≥n semanal para temporada $SEASON..."
          echo "üîÑ Secuencia: Stats ‚Üí Puntos ‚Üí Eliminaci√≥n ‚Üí Avance de semana"
          echo ""

          # Llamar a la Edge Function con mejor manejo de errores
          response=$(curl -X POST "$SUPABASE_URL/functions/v1/weekly-elimination" \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            -d "{\"action\": \"tuesday_3am_process\", \"season\": $SEASON}" \
            --fail-with-body \
            --max-time 120 \
            -w "\n\nHTTP_STATUS:%{http_code}\nTIME_TOTAL:%{time_total}s\n")

          # Extraer c√≥digo HTTP y tiempo
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          time_total=$(echo "$response" | grep "TIME_TOTAL:" | cut -d: -f2)

          # Mostrar resultado
          echo "üìä Respuesta del servidor:"
          echo "$response" | head -n -2
          echo ""
          echo "‚è±Ô∏è Tiempo de respuesta: $time_total"
          echo "üì° C√≥digo HTTP: $http_status"

          # Verificar √©xito
          if [ "$http_status" = "200" ]; then
            echo "‚úÖ Proceso de eliminaci√≥n completado exitosamente"

            # Parsear m√©tricas (opcional)
            eliminations=$(echo "$response" | head -n -2 | jq -r '.successful_eliminations // 0')
            advancements=$(echo "$response" | head -n -2 | jq -r '.successful_advancements // 0')
            total=$(echo "$response" | head -n -2 | jq -r '.total_processed // 0')

            echo "üìà M√©tricas:"
            echo "  - Ligas procesadas: $total"
            echo "  - Eliminaciones exitosas: $eliminations"
            echo "  - Avances de semana: $advancements"
          else
            echo "‚ùå Error en proceso de eliminaci√≥n"
            exit 1
          fi

      - name: Esperar completaci√≥n de operaciones de base de datos
        run: |
          echo "‚è≥ Esperando 10 segundos para completar operaciones de DB..."
          sleep 10

      - name: Step 2 - Sincronizar proyecciones semanales
        id: projections
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET || secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SEASON: ${{ steps.season.outputs.SEASON }}
        run: |
          echo "üìä Iniciando sincronizaci√≥n de proyecciones para nueva semana (temporada $SEASON)..."
          echo ""

          # Llamar a la Edge Function de proyecciones
          response=$(curl -X POST "$SUPABASE_URL/functions/v1/sync-projections" \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            -d "{\"season\": $SEASON, \"seasonType\": \"REG\"}" \
            --fail-with-body \
            --max-time 120 \
            -w "\n\nHTTP_STATUS:%{http_code}\nTIME_TOTAL:%{time_total}s\n")

          # Extraer c√≥digo HTTP y tiempo
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          time_total=$(echo "$response" | grep "TIME_TOTAL:" | cut -d: -f2)

          # Mostrar resultado
          echo "üìä Respuesta del servidor:"
          echo "$response" | head -n -2
          echo ""
          echo "‚è±Ô∏è Tiempo de respuesta: $time_total"
          echo "üì° C√≥digo HTTP: $http_status"

          # Verificar √©xito (no falla el workflow si esto falla)
          if [ "$http_status" = "200" ]; then
            echo "‚úÖ Sincronizaci√≥n de proyecciones completada exitosamente"

            # Parsear m√©tricas
            updated=$(echo "$response" | head -n -2 | jq -r '.updatedPlayers // 0')
            week=$(echo "$response" | head -n -2 | jq -r '.week // 0')

            echo "üìà M√©tricas:"
            echo "  - Jugadores actualizados: $updated"
            echo "  - Semana: $week"
          else
            echo "‚ö†Ô∏è Error en sincronizaci√≥n de proyecciones (no cr√≠tico, continuando)"
            # No hacer exit 1 aqu√≠ - las proyecciones son opcionales
          fi

      - name: Resumen del proceso semanal
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìã RESUMEN - Proceso Semanal NFL"
          echo "=========================================="
          echo "üìÖ Temporada: ${{ steps.season.outputs.SEASON }}"
          echo "üïê Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "üìä Estado de los pasos:"
          echo "  1. Eliminaci√≥n semanal: ${{ steps.elimination.outcome }}"
          echo "  2. Proyecciones: ${{ steps.projections.outcome }}"
          echo ""
          if [ "${{ steps.elimination.outcome }}" = "success" ]; then
            echo "‚úÖ Proceso semanal completado exitosamente"
          else
            echo "‚ùå Proceso semanal fall√≥ en eliminaci√≥n"
          fi
          echo "=========================================="
